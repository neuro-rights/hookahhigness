{% load static %}

<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hookah Higness NFT Marketplace ᕙ(⇀‸↼‶)ᕗ</title>

    {% load django_bootstrap5 %}
    
    {# Load CSS and JavaScript #}
    {% bootstrap_css %}

    {% block css %} 
	<!-- Our project just needs Font Awesome Free's Solid and Brand files -->
    <link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">
    <link href="//cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/base.css' %}">
    {% endblock css %}

    {% block extrajs %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.12.1/datatables.min.js"></script>
    <script src="https://unpkg.com/ipfs-http-client/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    {% endblock  %}

    {% bootstrap_javascript %}
    
    {# Display django.contrib.messages as Bootstrap alerts #}
    {% bootstrap_messages %}

    {% block extrahead %}
    {% endblock %}
</head>

<body class="d-flex flex-column h-100">
	
	<nav class="navbar navbar-dark bg-dark text-white">
		<div class="d-flex container-fluid">
			<div class="row flex-fill">
				<div class="col align-items-center d-flex gap-5">
                    <button class="navbar-toggler align-middle" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <a class="navbar-brand">NFT Market ᕙ(⇀‸↼‶)ᕗ</a>
				</div>
	
				{% if user.is_authenticated %}
                <div class="col">
                    <div class="row d-grid gap-3">
                        <div class="col ml-auto d-flex align-items-center justify-content-end">
                            <div class="nav-item">{{ user.username }}</div>
                        </div>
                    </div>
                    <div class="row d-grid gap-3">
                        <div class="col d-flex align-items-center justify-content-end nav-item">
                            <a href="{% url 'profile' %}" class="nav-link"><i class="fa fa-user-pen"></i> settings</a>
                            <a href="{% url 'logout' %}" class="nav-link"><i class="fa fa-person-running"></i> logout</a>
                        </div>
                    </div>
                </div>
				{% else %}
                <div class="col">
                    <div class="row">
                        <div class="col d-flex align-items-center navitem">&nbsp;</div>
                    </div>
                    <div class="row d-grid gap-3">
                        <div class="col ml-auto d-flex align-items-center justify-content-end nav-item">
                            <!--
                            <button class="nav-link enableSignupButton"><i class="fa fa-user-lock"></i> signup</button>
                            -->
                            <button class="nav-link enableLoginButton" id="auth-metamask"><i class="fa fa-fingerprint"></i> login</button>
                            <h2>Account: <span class="showAccount"></span></h2>
                        </div>
                    </div>
                </div>
				{% endif %}
			</div>
		</div>
	</nav>
	
	<nav class="navbar navbar-dark text-white">
		<div class="collapse show navbar-collapse" id="navbarContent">
            <div class="d-flex container-fluid">
                <div class="row flex-fill">

                    {% comment %}
                    <div class="col-4 d-flex justify-content-start">
                        <form class="form-inline w-100" action="{% url 'search_result' %}" method="get">
                            <input id="searchbar" class="form-control d-inline-block w-100" type="search" placeholder="Search" aria-label="Search">
                        </form>
                    </div>
                    {% endcomment %}

                    {% if user.is_authenticated %}
                    <div class="col ml-auto d-flex justify-content-end">
                        <div class="row">
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">PURCHASES</a>
                                <div id='purchases' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'purchases_bought_list' %}">LIST BOUGHT PURCHASES</a>
                                    {% comment %}
                                    <a class="dropdown-item" href="{% url 'purchases_sold_list' %}">LIST SOLD PURCHASES</a>
                                    {% endcomment %}
                                </div>
                            </div>
                            {% comment %}
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">BIDS</a>
                                <div id='auctions' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'bids_made_list' %}">LIST MADE BIDS</a>
                                    <a class="dropdown-item" href="{% url 'bids_received_list' %}">LIST RECEIVED BIDS</a>
                                </div>
                            </div>
                            {% endcomment %}
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">AUCTIONS</a>
                                <div id='auctions' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'auction_create' %}">NEW AUCTION</a>
                                    <a class="dropdown-item" href="{% url 'auctions_own_scheduled' %}">LIST SCHEDULED AUCTIONS</a>
                                    <a class="dropdown-item" href="{% url 'auctions_own_running' %}">LIST RUNNING AUCTIONS</a>
                                    <a class="dropdown-item" href="{% url 'auctions_own_ended' %}">LIST ENDED AUCTIONS</a>
                                </div>
                            </div>
                            {% comment %}
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">TICKETS</a>
                                <div id='raffles' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'tickets' %}">TODO</a>
                                </div>
                            </div>
                            {% endcomment %}
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">RAFFLES</a>
                                <div id='raffles' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'raffle_create' %}">NEW RAFFLE</a>
                                    <a class="dropdown-item" href="{% url 'raffles_own_running' %}">LIST RUNNING RAFFLES</a>
                                    <a class="dropdown-item" href="{% url 'raffles_own_scheduled' %}">LIST SCHEDULED RAFFLES</a>
                                    <a class="dropdown-item" href="{% url 'raffles_own_ended' %}">LIST ENDED RAFFLES</a>
                                </div>
                            </div>
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">COLLECTIONS</a>
                                <div id='collections' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'collection_create' %}">NEW COLLECTION</a>
                                    <a class="dropdown-item" href="{% url 'collections_own' %}">LIST OWN COLLECTIONS</a>
                                </div>
                            </div>
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">ASSETS</a>
                                <div id='assets' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'asset_create' %}">NEW</a>
                                    <a class="dropdown-item" href="{% url 'assets_own' %}">LIST</a>
                                </div>
                            </div>
                            {% comment %}
                            <div class="col nav-item dropdown">
                                <a class="nav-link dropdown-toggle btn btn-lg" data-bs-toggle="dropdown" href="#">OPENSEA</a>
                                <div id='assets' class='dropdown-menu dropdown-menu-end'>
                                    <a class="dropdown-item" href="{% url 'opensea' %}">TODO</a>
                                </div>
                            </div>
                            {% endcomment %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
		</div>
	</nav>

    <main class="container mt-5">
        {% block content %} {% endblock %}
    </main>

    <footer class="footer mt-auto">
        <div class="right">&copy; 2022 NFT Market &nbsp; \(ᵔᵕᵔ)/</div>
    </footer>

    {% if user.is_authenticated %}
    {% else %}
    <script>
    const elBtnMetamask = document.getElementById('auth-metamask');

    const handleApiPost = async (endpoint, params) => {
      const result = await axios.post(`${endpoint}`, params, {
        headers: {
          'content-type': 'application/json',
          "X-CSRFToken": '{{ csrf_token }}'
        },
      });
    
      return result.data;
    };

    const requestMessage = (account, chain) =>
      handleApiPost('{% url 'request_message' %}', {
        address: account,
        chain: chain,
        network: 'evm',
      });

    const verifyMessage = (message, signature) =>
      handleApiPost('{% url 'verify_message' %}', {
        message,
        signature,
        network: 'evm',
      });

    const connectToMetamask = async () => {
      const provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
    
      const [accounts, chainId] = await Promise.all([
        provider.send('eth_requestAccounts', []),
        provider.send('eth_chainId', []),
      ]);

      const signer = provider.getSigner();
      return { signer, chain: chainId, account: accounts[0] };
    };

    const handleAuth = async () => {
      // Connect to Metamask
      const { signer, chain, account } = await connectToMetamask();
      console.log("account", account, "chain", chain)

      if (!account) {
        throw new Error('No account found');
      }
      if (!chain) {
        throw new Error('No chain found');
      }

      const { message } = await requestMessage(account, chain);
      const signature = await signer.signMessage(message);
      const { user } = await verifyMessage(message, signature);
      console.log(user)
      if (user) {
        location.reload();
      }
      else{
        alert("authentication error")
      }
    };


    function init() {
      elBtnMetamask.addEventListener('click', async () => {
        handleAuth().catch((error) => console.log(error));
      });
    }

    window.addEventListener('load', () => {
      init();
    });

    </script>
    {% endif %}
 
    <!--
    <script>
        $( document ).ready(function() {
            console.log( "document loaded" );
            const loginButton = document.querySelector('.enableLoginButton');
            const signupButton = document.querySelector('.enableSignupButton');
            const showAccount = document.querySelector('.showAccount');

            loginButton.addEventListener('click', () => {
                login();
            });

            signupButton.addEventListener('click', () => {
                signup();
            });

            async function signup() {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                showAccount.innerHTML = account;

                $.ajax({
                    type: 'POST',
                    url: "/metamask/",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "user": {
                            "username": "test1",
                        },
                        "public_address": "1231#!@312jbwi12y3br",
                    }),
                    dataType: 'json',
                    success: function(res){
                        console.log(res)
                        login();
                    },
                    error: function(err) {
                        console.log(err)
                    }
                })
            }

            async function login() {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                showAccount.innerHTML = account;
                const message = [
                    "I have read and accept the terms and conditions of this app.",
                    "Please sign me in!"
                ].join("\n")
                const sign = await ethereum.request({ method: 'personal_sign', params: [ message, account ] });
                console.log(sign);

                $.ajax({
                    type: 'POST',
                    url: "/metamask/login/" + account,
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    contentType: 'application/json',
                    data: JSON.stringify({
                        signature : sign
                    }),
                    dataType: 'json',
                    success: function(res){
                        console.log(res["access"])
                        $.ajax({
                            type: 'GET',
                            url: "/",
                            headers: {'Authorization': 'Bearer '+res["access"]},
                            success: function(data){
                                console.log(data)
                            },
                            error: function(err) {
                                console.log(err)
                            }
                        })
                    },
                    error: function(err) {
                        console.log(err)
                    }
                })
            }
        });
    </script>
    -->
    {% block javascript %} {% endblock %}
</body>

</html>
